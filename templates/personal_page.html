<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <title>Personal page</title>
    <script>
      // ініціалізація при завантаженні сторінки
      document.addEventListener("DOMContentLoaded", () => {
        updateSubCategories();
      });
      </script>
</head>
<body>
    <div class="d-flex flex-column flex-md-row align-items-center pb-3 mb-4 border-bottom">
        <a href="{{ url_for('index') }}" class="d-flex align-items-center link-body-emphasis text-decoration-none">
          <span class="fs-4">Clothing shop</span>
        </a>
  
        <nav class="d-inline-flex mt-2 mt-md-0 ms-md-auto">
          <a class="me-3 py-2 link-body-emphasis text-decoration-none" href="{{ url_for('clothing') }}">Clothing</a>
          <a class="me-3 py-2 link-body-emphasis text-decoration-none" href="{{ url_for('shoes') }}">Shoes</a>
          <a class="me-3 py-2 link-body-emphasis text-decoration-none" href="{{ url_for('accessories') }}">Accessories</a>
          <a class="me-3 py-2 link-body-emphasis text-decoration-none" href="{{ url_for('logout') }}">
            <img src="{{ url_for('static', filename='logout.png') }}" alt="logout" width="25" height="25">
          </a>
        </nav>
      </div>

      <p align="center">Profile</p>
      <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
        <h2 style="margin: 0;"><p align="center">{{ user.first_name }}</p></h2>
        <button onclick="toggleProfile()" class="button_personal_info" id="toggleButton">
          <img src="{{ url_for('static', filename='user.png') }}" alt="arrow" style=" width: 25px; height: 25px;">
        </button>
      </div>
    <br>
    <div class="container">
      <div id="userProfile" style="display:none;" class="div_box">
        <h2>Personal information</h2>
        <p><strong>Name:</strong> {{ user.first_name }}</p>
        <p><strong>Surname:</strong> {{ user.last_name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>Phone number:</strong> +360{{ user.phone_number }}</p>
      </div>

      <script>
        function toggleProfile() {
            var profileDiv = document.getElementById("userProfile");
            if (profileDiv.style.display === "none") {
                profileDiv.style.display = "block";
            } else {
                profileDiv.style.display = "none";
            }
        }
        </script>
    </div>

    {% if user.first_name != 'admin'%}
    <h2 align="center">Your orders</h2>
    <hr><br>

    {% if orders %}
    {% for order in orders %}
    <div class="card mb-3 p-3">
      <h5>Order №{{ order.id }} – {{ order.created_at.strftime('%d-%m-%Y') }}</h5>
      <p>Status: <strong>{{ order.status }}</strong></p>
      
      <ul>
        {% for item in order.items %}
          <li>
            <img src="{{ url_for('static', filename=item.item.image.split('static/')[-1].replace('\\', '/')) }}" width="60" height="60">
            {{ item.item.brand }} – {{ item.item.name }} |
            Size: {{item.item.size}} |
            Price: {{ item.price_at_purchase }}$ |
            Amount: {{ item.quantity }}
          </li>
        {% endfor %}
      </ul>

      {% if order.status == 'Pending' %}
      <div style="display: flex; gap: 10px; align-items: center;">
        <form method="POST" action="{{ url_for('pay_order', order_id=order.id) }}">
          <button type="submit" class="btn btn-dark">Pay</button>
        </form>
        <form action="{{ url_for('delete_order', order_id=order.id) }}" method="post" onsubmit="return confirm('Do you really want to delete this order??');">
          <button class="btn btn-outline-danger"><img src="{{ url_for('static', filename='trash.png') }}" alt="Delete order" style=" width: 25px; height: 25px"></button>
        </form>
      </div>
        
      {% else %}
        <button class="btn btn-secondary" disabled>Paid</button>
      {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <p>You have no orders yet.</p>
    {% endif %}

    {% endif %}

    {% if user.first_name == 'admin' %}
    <br>
        

        <div class="container">
          <button onclick="toggleUserList()" class="btn btn-dark">View the list of users</button>
        </div>
        <br>
        <div class="container">
          <div id="user-list" class="div_box" style="display:none;"></div>
        <script>
        function toggleUserList() {
          let userListDiv = document.getElementById('user-list');
          
          if (userListDiv.style.display === 'block') {
            userListDiv.style.display = 'none';
            return;
          }
          
          fetch('/api/users')
          .then(response => response.json())
          .then(users => {
            userListDiv.innerHTML = '';
            users.forEach(user => {
              let userDiv = document.createElement('div');
              userDiv.className = 'user-item';
              userDiv.innerHTML = `
              <span>${user.id}: ${user.first_name} ${user.last_name} - ${user.email} (${user.phone_number})</span>
              <button class="btn btn-outline-danger" onclick="deleteUser(${user.id}, this)">Delete</button>
              `;
              userListDiv.appendChild(userDiv);
            });
            userListDiv.style.display = 'block';
          })
          .catch(error => console.error('Error loading users:', error));
        }
          
          function deleteUser(userId, button) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            fetch(`/api/users/${userId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
              if (data.message) {
                button.parentElement.remove();
              }
            })
            .catch(error => console.error('Error deleting user:', error));
            }
            </script>
        </div>
        
        <br>

        <div class="container">
          <a href="{{ url_for('order_list') }}">
            <button class="btn btn-dark">View order list</button>
          </a>
        </div>
        <br>

        <div class="container">
          <a href="{{ url_for('item_list')}}">
            <button class="btn btn-dark">View the list of products</button>
          </a>

        </div>
    {% endif %}

    <br><br>

    <footer class="row row-cols-1 row-cols-sm-2 row-cols-md-5 py-5 my-5 border-top">
      
      <div class="col mb-3">
        <h5>HELP AND INFORMATION</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">About Clothing shop</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Shop rules</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Return conditions</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Cooperation</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Frequently asked questions</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Contact</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Privacy Policy</a></li>
        </ul>
      </div>

      <div></div>
  
      <div class="col mb-3">
        <h5>DELIVERY</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">To the post office</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">By courier</a></li>
        </ul>
      </div>
      
      <div></div>
  
      <div class="col mb-3">
        <h5>PAYMENT</h5>
        <ul class="nav flex-column">
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">By bank card</a></li>
          <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Postpaid</a></li>
        </ul>
      </div>
    </footer>
</body>
</html>